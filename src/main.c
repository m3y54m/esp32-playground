#include <driver/gpio.h>
#include <driver/uart.h>
#include <driver/i2c.h>
#include <freertos/FreeRTOS.h>
#include <freertos/task.h>
#include <string.h>
#define LOG_LOCAL_LEVEL ESP_LOG_VERBOSE
#include <esp_log.h>
#include <freertos/semphr.h>
#include <driver/adc.h>
#include <esp_adc_cal.h>
#include <esp_timer.h>

#include <u8g2.h>
#include <u8g2_esp32_hal.h>

// LCD Control Pins
#define SPI_MISO_PIN 19
#define SPI_MOSI_PIN 23
#define SPI_CLK_PIN 18
#define LCD_CS_PIN 27
#define LCD_RST_PIN 14
#define LCD_DC_PIN 12 // A0
// LCD Backlight
#define LCD_BL_PIN 13

esp_adc_cal_characteristics_t adc1_chars;

const uint8_t font_pixia_10_fa[3102] U8G2_FONT_SECTION("font_pixia_10_fa") =
    "\372\0\3\2\4\4\6\4\6\25\14\0\375\6\0\6\376\0\0\0\0\0\375 \6\0`\212\0!\10a"
    " \212\30\222\0%\7D \226\210z(\11\203\240\221JJm\5)\12\203\240\221\310J-%\0*"
    "\12U \232\312\26\313\26\1+\12D \226\312\222!J\0,\10B \216\30\22\5-\7\25`\232"
    "\30\4.\6\21 \212\10/\10U \232\314:\2\60\12D!\226Q\42)Q\0\61\6a!\212\70"
    "\62\13e!\232\310\264A\11\213\0\63\14e!\232H\22%\31\224\260\10\64\13e!\232[\242$\32"
    "\306\20\65\13e!\232J\243HS\272\0\66\13e!\232\311\302,\331j\0\67\14e!\232\310\264\244"
    "\224da\4\70\14e!\232\12\263$JjZ\0\71\12d!\226Q\42)\331\12:\7\61 \212H"
    "\2=\10\64 \226\30\302![\11\203\240\221\30\242\236\6]\11\203\240\221\230z\32\2{\13\203\240\221"
    "J\242J\26e\1}\14\203\240\221\310\242Z\22%\21\0\0\0\0\10\376\202\4\343\377\377\6\14\11B"
    " \216Q\206\0\6\33\12r \216Q\206h\10\6\37\14t \226Q\42\261\16$\0\6!\10\42 "
    "\216\210\2\6\42\12d \222\31\322\254\5\6#\12b \212H\242\244\1\6$\16\204\241\225\311\1%"
    "\222\222mH\0\6%\12rs\325\351\224$\0\6&\22\207`\235\311!)\211\244,S\322$\214\206"
    "\4\6'\10A!\212\30\2\6(\15h\240\241\211c\71\31v\64\4\6)\15\205 \226\11\253YR"
    "\323\222\5\6*\15X \242K\262\70\226\223a\1\6+\16h \242\214\223,\216\345dX\0\6,"
    "\17g\240\235\23\243\34H\6%\7\226\4\6-\17g\240\235\23\243\34H\6%\7\66\0\6.\20w"
    "\240\235\311\21\61\312\201dPr`\3\6/\13U\341\231JS)\222\0\6\60\14e\341\231\210\323T"
    "\212$\0\6\61\12T\240\221kJ$\0\6\62\14t\240\221\313\201\254\224H\0\6\63\17X\240\241K"
    "\22)I$\245\224\252\0\6\64\22\210\240\241\215\223\34M\22)I$\245\224\252\0\6\65\17h\240\241"
    "\225JR&\15I\224\252\0\6\66\20x\240\241\313!\251$e\322\220D\251\12\6\67\17W!\242\211"
    "#)\211\22m\30\22\0\6\70\17W!\242)FR\22%\332\60$\0\6\71\14u`\225\223\302l"
    "\20\323!\6:\15\205`\225\211\245\60\33\304t\10\6@\7\22 \212\20\6A\17h \242\315)J"
    "\26iQ\62,\0\6B\20\207\240\235\324Q\61\222\42mH\223A\1\6C\17X \242\34\262\60\32"
    "\222\70\31\26\0\6D\14f\340\231\255d\242\26M\0\6E\20w\240\235L\223LJJ\232\222\3)"
    "\0\6F\15g\240\235\13CUM\262l\2\6G\15e \226I\263\244\246%\13\0\6H\14d\241"
    "\225Q\42)\331\206\4\6I\21w`\235\224\222H\312\62%M\302hH\0\6J\21w`\235\224\222"
    "H\312\62%M\302hH\0\6K\7!\341\203\20\6L\7!\342\203\20\6M\7\0`\201\0\6N"
    "\7\21\341\203\10\6O\7!\341\203\20\6P\7\0a\201\0\6Q\7\22\341\203\20\6R\7!\341\203"
    "\20\6`\13D!\226Q\42)Q\0\6a\7a!\212\70\6b\14e!\232\310\264A\11\213\0\6"
    "c\15e!\232H\22%\31\224\260\10\6d\14e!\232[\242$\32\306\20\6e\14e!\232J\243"
    "HS\272\0\6f\14e!\232\311\302,\331j\0\6g\15e!\232\310\264\244\224da\4\6h\15"
    "e!\232\12\263$JjZ\0\6i\13d!\226Q\42)\331\12\6~\16x`\241\211c\71\31v"
    "T\16\1\6\206\17g\240\235\23\243\34H\6%\7\224\1\6\230\15\204\240\221\252\344@VJ$\0\6"
    "\251\17X \242\34\262\60\32\222\70\31\26\0\6\257\17h \242\35\207,\214\206$N\206\5\6\300\15"
    "\205 \226\11\253YR\323\222\5\6\314\21w`\235\224\222H\312\62%M\302hH\0\6\360\13D!"
    "\226Q\42)Q\0\6\361\7a!\212\70\6\362\14e!\232\310\264A\11\213\0\6\363\15e!\232H"
    "\22%\31\224\260\10\6\364\14e!\232[\242$\32\306\20\6\365\14e!\232J\243HS\272\0\6\366"
    "\14e!\232\311\302,\331j\0\6\367\15e!\232\310\264\244\224da\4\6\370\15e!\232\12\263$"
    "JjZ\0\6\371\13d!\226Q\42)\331\12\373V\16x`\241\211c\71\31vT\16\1\373W\16"
    "x`\241\211c\71\31vT\16\1\373X\12c`\215\212\306\244\2\373Y\12c`\215\212\306\244\2\373"
    "z\17g\240\235\23\243\34H\6%\7\224\1\373{\17g\240\235\23\243\34H\6%\7\224\1\373|\16"
    "v`\231\322\242x\330\241$\214\0\373}\16v`\231\322\242x\330\241$\214\0\373\212\15\204\240\221\252"
    "\344@VJ$\0\373\213\15\204\240\221\252\344@VJ$\0\373\216\17X \242\34\262\60\32\222\70\31"
    "\26\0\373\217\17X \242\34\262\60\32\222\70\31\26\0\373\220\14V \232\32\222t\210\207\5\373\221\14"
    "V \232\32\222t\210\207\5\373\222\17h \242\35\207,\214\206$N\206\5\373\223\17h \242\35\207"
    ",\214\206$N\206\5\373\224\15f \232\233\206$\35\342a\1\373\225\15f \232\233\206$\35\342a"
    "\1\373\244\15\205 \226\11\253YR\323\222\5\373\245\14d`\222\311\201!\222\222\2\373\374\21w`\235"
    "\224\222H\312\62%M\302hH\0\373\375\16X\240\241\211\244\226,\22\263!\3\373\376\11S\240\215\212"
    "F\5\373\377\11S\240\215\212F\5\376\201\12d \222\31\322\254\5\376\202\12d`\216\31\322\254\5\376"
    "\203\12b \212H\242\244\1\376\204\12b \212H\242\244\1\376\205\16\204\241\225\311\1%\222\222mH"
    "\0\376\206\16\204\241\225\311\1%\222\222mH\0\376\207\12rs\325\351\224$\0\376\210\12r`\211\351"
    "\224$\0\376\211\22\207`\235\311!)\211\244,S\322$\214\206\4\376\212\20x\240\241\312\201\70\222Z"
    "\262H\314\206\14\376\213\11C \216\10\243\5\376\214\11C \216\10\243\5\376\215\10A!\212\30\2\376"
    "\216\10Aa\212\30\2\376\217\15h\240\241\211c\71\31v\64\4\376\220\15h\240\241\211c\71\31v\64"
    "\4\376\221\11S\240\215\212\326\4\376\222\11S\240\215\212\326\4\376\223\15\205 \226\11\253YR\323\222\5"
    "\376\224\14d`\222\311\201!\222\222\2\376\225\15X \242K\262\70\226\223a\1\376\226\15X \242K"
    "\262\70\226\223a\1\376\227\11S \216Q\243\5\376\230\11S \216Q\243\5\376\231\16h \242\214\223"
    ",\216\345dX\0\376\232\16h \242\214\223,\216\345dX\0\376\233\12c \216\211\324h\1\376\234"
    "\12c \216\211\324h\1\376\235\17g\240\235\23\243\34H\6%\7\226\4\376\236\17g\240\235\23\243\34"
    "H\6%\7\226\4\376\237\14f\240\231\322\242x\330\261\10\376\240\14f\240\231\322\242x\330\261\10\376\241"
    "\17g\240\235\23\243\34H\6%\7\66\0\376\242\17g\240\235\23\243\34H\6%\7\66\0\376\243\13F"
    " \232\322\242xX\0\376\244\13F \232\322\242xX\0\376\245\20w\240\235\311\21\61\312\201dPr"
    "`\3\376\246\20w\240\235\311\21\61\312\201dPr`\3\376\247\14V \232\310\1-\212\207\5\376\250"
    "\14V \232\310\1-\212\207\5\376\251\13U\341\231JS)\222\0\376\252\13U\341\231JS)\222\0"
    "\376\253\14e\341\231\210\323T\212$\0\376\254\14e\341\231\210\323T\212$\0\376\255\12T\240\221kJ"
    "$\0\376\256\12T\240\221kJ$\0\376\257\14t\240\221\313\201\254\224H\0\376\260\14t\240\221\313\201"
    "\254\224H\0\376\261\17X\240\241K\22)I$\245\224\252\0\376\262\17X\240\241K\22)I$\245\224"
    "\252\0\376\263\14\67 \236JJI\262T\0\376\264\14\67 \236JJI\262T\0\376\265\22\210\240\241"
    "\215\223\34M\22)I$\245\224\252\0\376\266\22\210\240\241\215\223\34M\22)I$\245\224\252\0\376\267"
    "\17g \236L\223\34KJI\262T\0\376\270\17g \236L\223\34KJI\262T\0\376\271\17h"
    "\240\241\225JR&\15I\224\252\0\376\272\17h\240\241\225JR&\15I\224\252\0\376\273\15G \236"
    "\224\222(\321\224!\1\376\274\15G \236\224\222(\321\224!\1\376\275\20x\240\241\313!\251$e\322"
    "\220D\251\12\376\276\20x\240\241\313!\251$e\322\220D\251\12\376\277\17W \236\312\21)\211\22M"
    "\31\22\0\376\300\17W \236\312\21)\211\22M\31\22\0\376\301\17W!\242\211#)\211\22m\30\22"
    "\0\376\302\17W \236\211#)\211\22m\30\22\0\376\303\17W \236\211#)\211\22m\30\22\0\376"
    "\304\17W \236\211#)\211\22m\30\22\0\376\305\17W!\242)FR\22%\332\60$\0\376\306\17"
    "W \236)FR\22%\332\60$\0\376\307\17W \236)FR\22%\332\60$\0\376\310\17W "
    "\236)FR\22%\332\60$\0\376\311\14u`\225\223\302l\20\323!\376\312\15v\240\231\31\222,\232"
    "\332\346\11\376\313\12D \222R\262h\10\376\314\14G \236\32\242,\233\226\1\376\315\15\205`\225\211"
    "\245\60\33\304t\10\376\316\17\226\240\231\312\261!\311\242\251m\236\0\376\317\13T \222\11\225,\32\2"
    "\376\320\15g \236\313\321!\312\262i\31\376\321\17h \242\315)J\26iQ\62,\0\376\322\17h"
    " \242\315)J\26iQ\62,\0\376\323\15e \226\312!\251\22\15\12\0\376\324\15e \226\312!"
    "\251\22\15\12\0\376\325\20\207\240\235\324Q\61\222\42mH\223A\1\376\326\20\207\240\235\324Q\61\222\42"
    "mH\223A\1\376\327\15e \226\322\21\251\22\15\12\0\376\330\15e \226\322\21\251\22\15\12\0\376"
    "\331\17X \242\34\262\60\32\222\70\31\26\0\376\332\17X \242\34\262\60\32\222\70\31\26\0\376\333\14"
    "V \232\32\222t\210\207\5\376\334\14V \232\32\222t\210\207\5\376\335\14f\340\231\255d\242\26M"
    "\0\376\336\14f\340\231\255d\242\26M\0\376\337\11R \212iQ\0\376\340\11R \212iQ\0\376"
    "\341\20w\240\235L\223LJJ\232\222\3)\0\376\342\20w\240\235L\223LJJ\232\222\3)\0\376"
    "\343\13F \232\323\242\322\242\0\376\344\13F \232\323\242\322\242\0\376\345\15g\240\235\13CUM\262"
    "l\2\376\346\15g\240\235\13CUM\262l\2\376\347\11S \216\211\243\5\376\350\11S \216\211\243"
    "\5\376\351\15e \226I\263\244\246%\13\0\376\352\12D`\222\31\42))\376\353\16f \232\212\303"
    "$JJ\321\242\0\376\354\20h\340\241R\243\60I\224%J\312)\0\376\355\14d\241\225Q\42)\331"
    "\206\4\376\356\14d\241\225Q\42)\331\206\4\376\357\21w`\235\224\222H\312\62%M\302hH\0\376"
    "\360\16X\240\241\211\244\226,\22\263!\3\376\361\21w`\235\224\222H\312\62%M\302hH\0\376\362"
    "\16X\240\241\211\244\226,\22\263!\3\376\363\11S\240\215\212F\5\376\364\11S\240\215\212F\5\376\365"
    "\17u \226Y\342$J\242$J\262\4\376\366\17u \226Y\342$J\242$J\262\4\376\367\13s"
    "!\222\210*.\25\0\376\370\13s!\222\210*.\25\0\376\371\13\203a\221H\134\212Q\4\376\372\13"
    "\203a\221H\134\212Q\4\376\373\12S!\222H\134*\0\376\374\12S!\222H\134*\0\0";

void adc_init(void)
{
  esp_adc_cal_characterize(ADC_UNIT_1, ADC_ATTEN_DB_0, ADC_WIDTH_BIT_DEFAULT, 0, &adc1_chars);
  adc1_config_width(ADC_WIDTH_BIT_DEFAULT);
  adc1_config_channel_atten(ADC1_CHANNEL_0, ADC_ATTEN_DB_0);
}

void app_main(void)
{
  vTaskDelay(pdMS_TO_TICKS(1000));
  printf("--- Hello World! ---\r\n");

  u8g2_esp32_hal_t u8g2_esp32_hal = {
      .clk = SPI_CLK_PIN,
      .mosi = SPI_MOSI_PIN,
      .cs = LCD_CS_PIN,
      .dc = LCD_DC_PIN,
      .reset = LCD_RST_PIN,
  };
  u8g2_esp32_hal_init(u8g2_esp32_hal);

  u8g2_t u8g2; // a structure which will contain all the data for one display
  u8g2_Setup_uc1701_mini12864_f(
      &u8g2,
      U8G2_R0,
      u8g2_esp32_spi_byte_cb,
      u8g2_esp32_gpio_and_delay_cb); // init u8g2 structure

  u8g2_InitDisplay(&u8g2); // send init sequence to the display, display is in
                           // sleep mode after this,

  // Turn on backlight
  gpio_reset_pin(LCD_BL_PIN);
  gpio_set_direction(LCD_BL_PIN, GPIO_MODE_OUTPUT);
  gpio_set_level(LCD_BL_PIN, 1);

  u8g2_SetPowerSave(&u8g2, 0);  // Wake up display
  u8g2_SetContrast(&u8g2, 255); // Set contrast ( important!!! )

  bool toggle = 0;

  while (1)
  {
    u8g2_ClearBuffer(&u8g2);
    u8g2_SetFont(&u8g2, font_pixia_10_fa);
    if (toggle)
    {
      u8g2_DrawUTF8(&u8g2, 58, 10, "ﻡﻼﺳ");
      u8g2_DrawButtonUTF8(&u8g2, 64, 60, U8G2_BTN_INV | U8G2_BTN_HCENTER | U8G2_BTN_BW0, 128, 0, 2, "ﻡﻼﺳ");
    }
    else
    {
      u8g2_DrawUTF8(&u8g2, 58, 60, "ﻡﻼﺳ");
      u8g2_DrawButtonUTF8(&u8g2, 64, 10, U8G2_BTN_INV | U8G2_BTN_HCENTER | U8G2_BTN_BW0, 128, 0, 2, "ﻡﻼﺳ");
    }
    u8g2_SendBuffer(&u8g2);

    toggle = !toggle;

    vTaskDelay(pdMS_TO_TICKS(1000));
  }
}